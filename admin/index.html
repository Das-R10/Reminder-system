<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RenewPulse — Admin Console</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       #0c0c0e;
      --surface:  #111115;
      --surface2: #18181f;
      --surface3: #1f1f28;
      --border:   #25252f;
      --border2:  #2e2e3a;
      --amber:    #e8a030;
      --green:    #2ecc71;
      --red:      #e74c3c;
      --blue:     #4a9eff;
      --text:     #e8e8f0;
      --text2:    #a0a0b8;
      --text3:    #5a5a72;
      --mono:     'IBM Plex Mono', monospace;
      --sans:     'IBM Plex Sans', sans-serif;
    }

    html, body { height: 100%; overflow: hidden; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      font-size: 13px;
      -webkit-font-smoothing: antialiased;
    }

    .shell {
      display: grid;
      grid-template-rows: 48px 1fr;
      height: 100vh;
    }

    /* TOP BAR */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      position: relative;
      z-index: 10;
    }
    .topbar-left { display: flex; align-items: center; gap: 20px; }
    .brand {
      display: flex; align-items: center; gap: 8px;
      font-family: var(--mono);
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.1em;
      color: var(--amber);
    }
    .brand-dot {
      width: 6px; height: 6px;
      background: var(--amber);
      border-radius: 50%;
      animation: pulse-dot 2.5s ease-in-out infinite;
    }
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    .breadcrumb {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text3);
      letter-spacing: 0.04em;
    }
    .breadcrumb span { color: var(--text2); }

    .topbar-right { display: flex; align-items: center; gap: 10px; }
    .status-pill {
      display: flex; align-items: center; gap: 5px;
      font-family: var(--mono); font-size: 10px; color: var(--text3);
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 3px 8px;
    }
    .status-dot {
      width: 5px; height: 5px; background: var(--green); border-radius: 50%;
      box-shadow: 0 0 5px rgba(46,204,113,0.7);
      animation: pulse-green 2s ease-in-out infinite;
    }
    @keyframes pulse-green {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.2; }
    }
    .topbar-btn {
      height: 28px; padding: 0 12px;
      background: transparent;
      border: 1px solid var(--border2);
      border-radius: 4px;
      color: var(--text2);
      font-family: var(--mono);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
      letter-spacing: 0.04em;
    }
    .topbar-btn:hover { border-color: var(--amber); color: var(--amber); }
    .topbar-btn.danger:hover { border-color: var(--red); color: var(--red); }

    /* BODY */
    .body-grid {
      display: grid;
      grid-template-columns: 220px 1fr 272px;
      overflow: hidden;
    }

    /* SIDEBAR */
    .sidebar {
      border-right: 1px solid var(--border);
      background: var(--surface);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    .sidebar::-webkit-scrollbar { width: 2px; }
    .sidebar::-webkit-scrollbar-thumb { background: var(--border2); }

    .s-section {
      padding: 14px;
      border-bottom: 1px solid var(--border);
    }
    .s-label {
      font-family: var(--mono);
      font-size: 9px;
      font-weight: 600;
      letter-spacing: 0.14em;
      color: var(--text3);
      text-transform: uppercase;
      margin-bottom: 9px;
    }

    /* KPI rows */
    .kpi-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-radius: 4px;
      background: var(--surface2);
      border: 1px solid var(--border);
      margin-bottom: 2px;
    }
    .kpi-row:last-child { margin-bottom: 0; }
    .kpi-lbl { font-size: 11px; color: var(--text2); }
    .kpi-val {
      font-family: var(--mono);
      font-size: 15px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }
    .c-amber { color: var(--amber); }
    .c-green  { color: var(--green); }
    .c-red    { color: var(--red); }
    .c-blue   { color: var(--blue); }

    .rev-box {
      margin-top: 8px;
      padding: 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 4px;
      border-top: 1px solid rgba(232,160,48,0.2);
    }
    .rev-lbl { font-family: var(--mono); font-size: 9px; letter-spacing: 0.1em; color: var(--text3); text-transform: uppercase; margin-bottom: 5px; }
    .rev-num { font-family: var(--mono); font-size: 22px; font-weight: 600; color: var(--amber); letter-spacing: -0.03em; }
    .rev-sub { display: flex; align-items: center; gap: 7px; margin-top: 5px; font-size: 11px; color: var(--text3); }
    .rev-badge {
      font-family: var(--mono); font-size: 9px; padding: 2px 6px;
      background: rgba(46,204,113,0.1); border: 1px solid rgba(46,204,113,0.2);
      color: var(--green); border-radius: 3px;
    }

    /* Action btns */
    .act-btn {
      width: 100%;
      display: flex; align-items: center; gap: 8px;
      padding: 7px 10px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text2);
      font-family: var(--mono);
      font-size: 11px;
      cursor: pointer;
      text-align: left;
      transition: all 0.15s;
      margin-bottom: 2px;
    }
    .act-btn:hover { border-color: var(--amber); color: var(--amber); background: rgba(232,160,48,0.03); }
    .act-icon { width: 14px; text-align: center; flex-shrink: 0; }

    /* Purchase items */
    .p-item {
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
      padding: 8px 10px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 2px;
    }
    .p-item:last-child { margin-bottom: 0; }
    .p-name { font-size: 12px; color: var(--text); font-weight: 500; }
    .p-meta { font-family: var(--mono); font-size: 10px; color: var(--text3); margin-top: 2px; }
    .p-amt  { font-family: var(--mono); font-size: 12px; font-weight: 600; color: var(--amber); white-space: nowrap; }

    /* MAIN */
    .main {
      overflow-y: auto;
      padding: 14px;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .main::-webkit-scrollbar { width: 2px; }
    .main::-webkit-scrollbar-thumb { background: var(--border2); }

    /* Metric strip */
    .metric-strip { display: grid; grid-template-columns: repeat(4,1fr); gap: 2px; }
    .m-cell {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 12px 14px;
    }
    .m-lbl {
      font-family: var(--mono); font-size: 9px; color: var(--text3);
      text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 6px;
    }
    .m-val {
      font-family: var(--mono); font-size: 20px; font-weight: 600; letter-spacing: -0.02em;
    }
    .m-sub { font-size: 10px; color: var(--text3); margin-top: 3px; }
    .m-bar { height: 2px; background: var(--border); border-radius: 1px; margin-top: 8px; overflow: hidden; }
    .m-bar-fill { height: 100%; border-radius: 1px; transition: width 1.2s cubic-bezier(0.4,0,0.2,1); }

    /* Chart panels */
    .cpanel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }
    .cpanel-hd {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .cpanel-title {
      font-family: var(--mono); font-size: 10px; font-weight: 600;
      letter-spacing: 0.08em; color: var(--text2); text-transform: uppercase;
    }
    .cpanel-sub { font-family: var(--mono); font-size: 10px; color: var(--text3); }
    .cpanel-body { padding: 14px; }
    .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    /* RIGHT */
    .right {
      border-left: 1px solid var(--border);
      background: var(--surface);
      display: flex; flex-direction: column;
      overflow: hidden;
    }
    .r-section {
      display: flex; flex-direction: column;
      overflow: hidden;
      border-bottom: 1px solid var(--border);
    }
    .r-hd {
      padding: 9px 14px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      flex-shrink: 0;
    }
    .r-title {
      font-family: var(--mono); font-size: 9px; font-weight: 600;
      letter-spacing: 0.12em; color: var(--text3); text-transform: uppercase;
    }
    .search-inp {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 3px 8px;
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text2);
      width: 110px;
      outline: none;
      transition: border-color 0.15s;
    }
    .search-inp:focus { border-color: var(--amber); }
    .search-inp::placeholder { color: var(--text3); }

    .t-wrap { flex: 1; overflow-y: auto; }
    .t-wrap::-webkit-scrollbar { width: 2px; }
    .t-wrap::-webkit-scrollbar-thumb { background: var(--border2); }

    table.ttbl { width: 100%; border-collapse: collapse; }
    table.ttbl thead th {
      padding: 6px 10px;
      font-family: var(--mono); font-size: 9px; color: var(--text3);
      text-align: left; font-weight: 500; letter-spacing: 0.05em;
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 1;
    }
    table.ttbl tbody td {
      padding: 7px 10px;
      font-size: 11px;
      border-bottom: 1px solid var(--border);
      color: var(--text2);
      vertical-align: middle;
    }
    table.ttbl tbody tr:hover td { background: var(--surface2); color: var(--text); }
    table.ttbl tbody tr:last-child td { border-bottom: none; }

    .ptag {
      display: inline-block; padding: 2px 6px; border-radius: 3px;
      font-family: var(--mono); font-size: 9px; font-weight: 600; letter-spacing: 0.03em;
    }
    .pt-s { background: rgba(74,158,255,0.1); color: var(--blue); border: 1px solid rgba(74,158,255,0.2); }
    .pt-b { background: rgba(232,160,48,0.1); color: var(--amber); border: 1px solid rgba(232,160,48,0.2); }
    .pt-e { background: rgba(46,204,113,0.1); color: var(--green); border: 1px solid rgba(46,204,113,0.2); }

    .r-actions {
      padding: 9px 14px; border-top: 1px solid var(--border);
      display: flex; gap: 6px; flex-shrink: 0;
    }
    .ra-btn {
      flex: 1; padding: 6px 10px;
      background: var(--surface2); border: 1px solid var(--border); border-radius: 4px;
      color: var(--text2); font-family: var(--mono); font-size: 10px; cursor: pointer;
      transition: all 0.15s;
    }
    .ra-btn:hover { border-color: var(--amber); color: var(--amber); }
    .ra-btn.r-red:hover { border-color: var(--red); color: var(--red); }

    /* LOG */
    .log-wrap { flex: 1; min-height: 0; display: flex; flex-direction: column; }
    .log-body { flex: 1; overflow-y: auto; padding: 8px 12px; }
    .log-body::-webkit-scrollbar { width: 2px; }
    .log-body::-webkit-scrollbar-thumb { background: var(--border2); }
    .log-entry {
      display: flex; gap: 10px;
      font-family: var(--mono); font-size: 10px; line-height: 1.8;
      border-bottom: 1px solid rgba(255,255,255,0.02); padding: 2px 0;
    }
    .log-entry:last-child { border-bottom: none; }
    .log-t { color: var(--text3); flex-shrink: 0; }
    .log-m { color: var(--text2); }
    .log-m.ok  { color: rgba(46,204,113,0.75); }
    .log-m.err { color: rgba(231,76,60,0.75); }
    .log-m.warn{ color: rgba(232,160,48,0.65); }

    /* page load */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(5px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .a1 { animation: fadeUp 0.35s ease both; }
    .a2 { animation: fadeUp 0.35s ease 0.07s both; }
    .a3 { animation: fadeUp 0.35s ease 0.14s both; }

    ::-webkit-scrollbar { width: 3px; height: 3px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }
  </style>
</head>
<body>

<div class="shell">

  <!-- TOP BAR -->
  <header class="topbar">
    <div class="topbar-left">
      <div class="brand"><div class="brand-dot"></div>RENEWPULSE</div>
      <div class="breadcrumb">/ <span>admin</span> / console</div>
    </div>
    <div class="topbar-right">
      <div class="status-pill">
        <div class="status-dot"></div>
        LIVE &nbsp;<span id="lastUpdatedTop" style="color:var(--text3)">—</span>
      </div>
      <button class="topbar-btn" id="refreshAll">↻&nbsp; REFRESH</button>
      <button class="topbar-btn" id="exportCSV">↓&nbsp; EXPORT</button>
      <button class="topbar-btn danger" id="logoutBtn">✕&nbsp; LOGOUT</button>
    </div>
  </header>

  <!-- BODY -->
  <div class="body-grid">

    <!-- SIDEBAR -->
    <aside class="sidebar">

      <div class="s-section a1">
        <div class="s-label">Overview</div>
        <div class="kpi-row">
          <span class="kpi-lbl">Tenants</span>
          <span id="totalTenants" class="kpi-val c-amber">—</span>
        </div>
        <div class="kpi-row">
          <span class="kpi-lbl">Total Jobs</span>
          <span id="totalJobs" class="kpi-val">—</span>
        </div>
        <div class="kpi-row">
          <span class="kpi-lbl">Sent</span>
          <span id="sentJobs" class="kpi-val c-green">—</span>
        </div>
        <div class="kpi-row">
          <span class="kpi-lbl">Failed</span>
          <span id="failedJobs" class="kpi-val c-red">—</span>
        </div>
        <div class="rev-box">
          <div class="rev-lbl">Monthly Revenue</div>
          <div id="monthlyRev" class="rev-num">₹—</div>
          <div class="rev-sub">MoM growth <span id="revPct" class="rev-badge">+—%</span></div>
        </div>
      </div>

      <div class="s-section a2">
        <div class="s-label">Recent Purchases</div>
        <div id="purchasesList"></div>
      </div>

      <div class="s-section a3">
        <div class="s-label">Actions</div>
        <button class="act-btn" onclick="simulatePurchase()">
          <span class="act-icon">+</span>Simulate Purchase
        </button>
        <button class="act-btn" onclick="clearCache()">
          <span class="act-icon">⌫</span>Clear Cache
        </button>
        <button class="act-btn" onclick="retryFailed()">
          <span class="act-icon">↺</span>Retry Failed Jobs
        </button>
      </div>

    </aside>

    <!-- MAIN -->
    <main class="main">

      <div class="metric-strip a1">
        <div class="m-cell">
          <div class="m-lbl">Delivery Rate</div>
          <div class="m-val c-green" id="deliveryRate">—%</div>
          <div class="m-sub">Last 30 days</div>
          <div class="m-bar"><div class="m-bar-fill c-green" id="deliveryBar" style="background:var(--green);width:0%"></div></div>
        </div>
        <div class="m-cell">
          <div class="m-lbl">Active Channels</div>
          <div class="m-val c-blue" id="activeChannels">—</div>
          <div class="m-sub">Email · SMS · WA</div>
          <div class="m-bar"><div class="m-bar-fill" id="channelBar" style="background:var(--blue);width:0%"></div></div>
        </div>
        <div class="m-cell">
          <div class="m-lbl">Avg Jobs / Tenant</div>
          <div class="m-val c-amber" id="avgJobs">—</div>
          <div class="m-sub">This month</div>
          <div class="m-bar"><div class="m-bar-fill" id="avgBar" style="background:var(--amber);width:0%"></div></div>
        </div>
        <div class="m-cell">
          <div class="m-lbl">ARPU</div>
          <div class="m-val c-amber" id="arpu">₹—</div>
          <div class="m-sub">Per tenant / mo</div>
          <div class="m-bar"><div class="m-bar-fill" id="arpuBar" style="background:var(--amber);width:0%"></div></div>
        </div>
      </div>

      <div class="cpanel a2">
        <div class="cpanel-hd">
          <div class="cpanel-title">Job Volume — Last 30 Days</div>
          <div class="cpanel-sub">Scheduled vs Sent</div>
        </div>
        <div class="cpanel-body">
          <canvas id="jobsChart" height="110"></canvas>
        </div>
      </div>

      <div class="chart-row a3">
        <div class="cpanel">
          <div class="cpanel-hd">
            <div class="cpanel-title">Channel Distribution</div>
            <div class="cpanel-sub">By volume</div>
          </div>
          <div class="cpanel-body">
            <canvas id="channelPie" height="160"></canvas>
          </div>
        </div>
        <div class="cpanel">
          <div class="cpanel-hd">
            <div class="cpanel-title">Revenue by Plan</div>
            <div class="cpanel-sub">Current month</div>
          </div>
          <div class="cpanel-body">
            <canvas id="purchasesBar" height="160"></canvas>
          </div>
        </div>
      </div>

    </main>

    <!-- RIGHT PANEL -->
    <aside class="right">

      <div class="r-section" style="flex:3;min-height:0">
        <div class="r-hd">
          <div class="r-title">Tenants</div>
          <input id="tenantSearch" class="search-inp" placeholder="Search…" />
        </div>
        <div class="t-wrap">
          <table class="ttbl">
            <thead>
              <tr>
                <th>Company</th>
                <th>Plan</th>
                <th>Joined</th>
              </tr>
            </thead>
            <tbody id="tenantTable"></tbody>
          </table>
        </div>
        <div class="r-actions">
          <button class="ra-btn" id="viewAllTenants">View All</button>
          <button class="ra-btn r-red" onclick="retryFailed()">Retry Failed</button>
        </div>
      </div>

      <div class="log-wrap">
        <div class="r-hd" style="flex-shrink:0">
          <div class="r-title">System Log</div>
          <span style="font-family:var(--mono);font-size:9px;color:var(--green)">● LIVE</span>
        </div>
        <div class="log-body" id="adminLog"></div>
      </div>

    </aside>

  </div>
</div>

<script>
  const token = localStorage.getItem('admin_token');
  const authH = () => ({ 'Content-Type': 'application/json', ...(token ? { Authorization: `Bearer ${token}` } : {}) });
  const $ = id => document.getElementById(id);

  // LOG
  function log(msg, type = '') {
    const t = new Date().toLocaleTimeString('en-US', { hour12: false });
    const div = document.createElement('div');
    div.className = 'log-entry';
    div.innerHTML = `<span class="log-t">${t}</span><span class="log-m ${type}">${msg}</span>`;
    $('adminLog').prepend(div);
    while ($('adminLog').children.length > 60) $('adminLog').lastChild.remove();
  }

  // DEMO DATA
  function demoData() {
    const now = new Date();
    const days = Array.from({ length: 30 }, (_, i) => {
      const d = new Date(now); d.setDate(now.getDate() - (29 - i));
      return { date: d.toISOString().slice(0, 10), scheduled: Math.floor(40 + Math.random() * 80), sent: Math.floor(30 + Math.random() * 60) };
    });
    const names = ['AquaFit','NovaSpa','ZenGym','CoreMax','PeakZone','FlexHub','IronHouse','PulseArc','VeloSport','ApexFit','ElitePro','TitanGym','UrbanYoga','SwiftFit','RapidPT','AlphaBox','FusionX','GridGym'];
    const plans = ['Starter','Business','Enterprise'];
    const tenants = names.map((n, i) => ({ company_name: n, plan: plans[i % 3], created_at: new Date(Date.now() - i * 86400000 * 7).toISOString() }));
    const purchases = [
      { company:'AquaFit',  plan:'Business',   amount:3999, at: new Date().toISOString() },
      { company:'PeakZone', plan:'Starter',     amount:999,  at: new Date(Date.now()-1800000).toISOString() },
      { company:'IronHouse',plan:'Enterprise',  amount:9999, at: new Date(Date.now()-5400000).toISOString() },
      { company:'FlexHub',  plan:'Starter',     amount:999,  at: new Date(Date.now()-9000000).toISOString() },
      { company:'NovaSpa',  plan:'Business',    amount:3999, at: new Date(Date.now()-18000000).toISOString() },
    ];
    return {
      days, tenants, purchases,
      stats: { total_tenants: tenants.length, total_jobs: days.reduce((s, d) => s + d.scheduled, 0), sent_jobs: days.reduce((s, d) => s + d.sent, 0), failed_jobs: 7, monthly_revenue: 12480000, revenue_pct: 11 }
    };
  }

  // CHARTS
  let jobsChart, channelPie, purchasesBar;
  Chart.defaults.color = '#5a5a72';
  Chart.defaults.borderColor = 'rgba(255,255,255,0.03)';
  Chart.defaults.font.family = "'IBM Plex Mono', monospace";
  Chart.defaults.font.size = 10;

  function renderCharts(days, purchases) {
    const labels = days.map(d => d.date.slice(5));
    if (jobsChart) jobsChart.destroy();
    jobsChart = new Chart($('jobsChart').getContext('2d'), {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label:'Scheduled', data: days.map(d=>d.scheduled), borderColor:'rgba(232,160,48,0.8)', backgroundColor:'rgba(232,160,48,0.04)', borderWidth:1.5, pointRadius:0, fill:true, tension:0.3 },
          { label:'Sent',      data: days.map(d=>d.sent),      borderColor:'rgba(46,204,113,0.8)',  backgroundColor:'rgba(46,204,113,0.04)', borderWidth:1.5, pointRadius:0, fill:true, tension:0.3 }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode:'index', intersect:false },
        plugins: { legend: { position:'top', align:'end', labels:{ boxWidth:10, boxHeight:2, padding:14, color:'#5a5a72' } } },
        scales: {
          x: { grid:{ color:'rgba(255,255,255,0.02)' }, ticks:{ color:'#3a3a52', maxTicksLimit:8, maxRotation:0 } },
          y: { grid:{ color:'rgba(255,255,255,0.03)' }, ticks:{ color:'#3a3a52', maxTicksLimit:4 } }
        }
      }
    });

    const e = Math.floor(Math.random()*40)+35, s = Math.floor(Math.random()*25)+20, w = Math.max(5, 100-e-s);
    if (channelPie) channelPie.destroy();
    channelPie = new Chart($('channelPie').getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: ['Email','SMS','WhatsApp'],
        datasets: [{ data:[e,s,w], backgroundColor:['rgba(74,158,255,0.7)','rgba(232,160,48,0.7)','rgba(46,204,113,0.7)'], borderColor:['rgba(74,158,255,0.3)','rgba(232,160,48,0.3)','rgba(46,204,113,0.3)'], borderWidth:1, hoverOffset:4 }]
      },
      options: { cutout:'68%', plugins:{ legend:{ position:'bottom', labels:{ boxWidth:8, boxHeight:8, padding:12, color:'#5a5a72' } } } }
    });

    const planMap = {};
    (purchases||[]).forEach(p => planMap[p.plan] = (planMap[p.plan]||0) + (p.amount||0));
    const pL = Object.keys(planMap), pV = pL.map(k=>planMap[k]);
    if (purchasesBar) purchasesBar.destroy();
    purchasesBar = new Chart($('purchasesBar').getContext('2d'), {
      type: 'bar',
      data: { labels:pL, datasets:[{ label:'₹', data:pV, backgroundColor:['rgba(74,158,255,0.45)','rgba(232,160,48,0.45)','rgba(46,204,113,0.45)'], borderColor:['rgba(74,158,255,0.8)','rgba(232,160,48,0.8)','rgba(46,204,113,0.8)'], borderWidth:1, borderRadius:3 }] },
      options: { plugins:{ legend:{ display:false } }, scales:{ x:{ grid:{ display:false }, ticks:{ color:'#3a3a52' } }, y:{ grid:{ color:'rgba(255,255,255,0.03)' }, ticks:{ color:'#3a3a52', maxTicksLimit:4 } } } }
    });
  }

  // TENANTS
  let allTenants = [];
  function renderTenants(list) {
    const tb = $('tenantTable'); tb.innerHTML = '';
    list.slice(0,60).forEach(t => {
      const pc = { Starter:'pt-s', Business:'pt-b', Enterprise:'pt-e' }[t.plan] || 'pt-s';
      const joined = t.created_at ? new Date(t.created_at).toLocaleDateString('en-IN', { month:'short', day:'numeric' }) : '—';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:90px;color:var(--text)">${t.company_name||t.company||'—'}</td><td><span class="ptag ${pc}">${t.plan||'—'}</span></td><td style="font-family:var(--mono);font-size:10px">${joined}</td>`;
      tb.appendChild(tr);
    });
  }
  $('tenantSearch').addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    renderTenants(q ? allTenants.filter(t => (t.company_name||'').toLowerCase().includes(q)||(t.plan||'').toLowerCase().includes(q)) : allTenants);
  });

  // REFRESH
  async function refreshAll() {
    log('Refreshing…', 'warn');
    $('lastUpdatedTop').textContent = new Date().toLocaleTimeString('en-US', { hour12:false });

    let apiStats=null, apiTenants=null, apiPurchases=null;
    try { const r=await fetch('/api/admin/stats',{headers:authH()}); if(r.ok){apiStats=await r.json();log('admin/stats OK','ok');}else log(`admin/stats → ${r.status}`,'err'); } catch { log('admin/stats unreachable','err'); }
    try { const r=await fetch('/api/admin/tenants',{headers:authH()}); if(r.ok){apiTenants=await r.json();log('admin/tenants OK','ok');}else log(`admin/tenants → ${r.status}`,'err'); } catch { log('admin/tenants unreachable','err'); }
    try { const r=await fetch('/api/admin/purchases',{headers:authH()}); if(r.ok){apiPurchases=await r.json();log('admin/purchases OK','ok');}else log(`admin/purchases → ${r.status}`,'err'); } catch { log('admin/purchases unreachable','err'); }

    const demo = demoData();
    const stats = apiStats || demo.stats;
    const tenants = (apiTenants&&Array.isArray(apiTenants)) ? apiTenants : demo.tenants;
    const purchases = (apiPurchases&&Array.isArray(apiPurchases)) ? apiPurchases : demo.purchases;

    // KPIs
    $('totalTenants').textContent = stats.total_tenants ?? '—';
    $('totalJobs').textContent    = (stats.total_jobs ?? 0).toLocaleString();
    $('sentJobs').textContent     = (stats.sent_jobs ?? 0).toLocaleString();
    $('failedJobs').textContent   = stats.failed_jobs ?? '—';
    $('monthlyRev').textContent   = '₹' + ((stats.monthly_revenue||0)/100).toLocaleString('en-IN');
    $('revPct').textContent       = '+' + (stats.revenue_pct||0) + '%';

    // Derived metrics
    const total = Math.max(1, stats.total_jobs||0);
    const sent  = stats.sent_jobs||0;
    const rate  = Math.round((sent/total)*100);
    $('deliveryRate').textContent = rate + '%';
    $('deliveryBar').style.width  = rate + '%';
    $('activeChannels').textContent = '3';
    $('channelBar').style.width     = '100%';
    const tc  = Math.max(1, stats.total_tenants||1);
    const avg = Math.round(total/tc);
    $('avgJobs').textContent = avg;
    $('avgBar').style.width  = Math.min(100, avg/2) + '%';
    const arpu = Math.round((stats.monthly_revenue||0)/100/tc);
    $('arpu').textContent   = '₹' + arpu.toLocaleString('en-IN');
    $('arpuBar').style.width = '55%';

    // Purchases sidebar
    $('purchasesList').innerHTML = '';
    purchases.slice(0,5).forEach(p => {
      const div = document.createElement('div');
      div.className = 'p-item';
      div.innerHTML = `<div style="min-width:0"><div class="p-name">${p.company}</div><div class="p-meta">${p.plan} · ${new Date(p.at||Date.now()).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})}</div></div><div class="p-amt">₹${(p.amount||0).toLocaleString()}</div>`;
      $('purchasesList').appendChild(div);
    });

    // Tenants
    allTenants = tenants;
    renderTenants(tenants);

    // Charts
    renderCharts(demo.days, purchases);
    log(`Loaded ${tenants.length} tenants, ${purchases.length} purchases`, 'ok');
  }

  // ACTIONS
  function simulatePurchase() {
    const co = ['AlphaSpin','FuseBox','DeltaPT','OmegaFit'][Math.floor(Math.random()*4)];
    const pl = ['Starter','Business','Enterprise'][Math.floor(Math.random()*3)];
    const am = {Starter:999,Business:3999,Enterprise:9999}[pl];
    const div = document.createElement('div');
    div.className = 'p-item'; div.style.borderColor = 'rgba(232,160,48,0.3)';
    div.innerHTML = `<div style="min-width:0"><div class="p-name">${co}</div><div class="p-meta">${pl} · just now</div></div><div class="p-amt">₹${am}</div>`;
    $('purchasesList').prepend(div);
    log(`Purchase: ${co} → ${pl}`, 'ok');
  }
  function clearCache() { localStorage.removeItem('admin_token'); log('Cache cleared','warn'); }
  function retryFailed() { log('Retrying failed jobs…','warn'); setTimeout(()=>log('Retry complete — 3 jobs requeued','ok'),1200); }
  function exportCSV() {
    const rows = [['Company','Plan','Joined']];
    Array.from($('tenantTable').children).forEach(tr => rows.push(Array.from(tr.children).map(td => td.textContent.trim())));
    const csv = rows.map(r => r.map(c=>`"${c.replace(/"/g,'""')}"`).join(',')).join('\n');
    const url = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    const a = document.createElement('a'); a.href=url; a.download=`tenants_${Date.now()}.csv`; a.click();
    URL.revokeObjectURL(url);
    log('Exported CSV','ok');
  }

  $('refreshAll').addEventListener('click', refreshAll);
  $('exportCSV').addEventListener('click', exportCSV);
  $('logoutBtn').addEventListener('click', () => { localStorage.removeItem('admin_token'); location.reload(); });

  refreshAll();
  setInterval(refreshAll, 1000 * 60 * 3);
</script>

</body>
</html>